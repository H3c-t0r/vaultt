{{!
  Copyright (c) HashiCorp, Inc.
  SPDX-License-Identifier: BUSL-1.1
~}}

<PageHeader as |p|>
  <p.top>
    {{! Ideally we'd generate breadcrumbs in route file instead of the component. However, that requires larger refactor of workflow. }}
    <Page::Breadcrumbs @breadcrumbs={{this.breadcrumbs}} />
  </p.top>
  <p.levelLeft>
    <h1 class="title is-3" data-test-secret-header="true">
      {{#unless (eq @mode "show")}}
        {{capitalize @mode}}
      {{/unless}}
      AWS Role
    </h1>
  </p.levelLeft>
</PageHeader>

{{#if (eq @mode "show")}}
  <Toolbar>
    <ToolbarActions>
      {{#if @model.canDelete}}
        <ConfirmAction
          @buttonText="Delete role"
          class="toolbar-button"
          @buttonColor="secondary"
          @onConfirmAction={{this.delete}}
        />
        <div class="toolbar-separator"></div>
      {{/if}}
      {{#if @model.canGenerate}}
        <ToolbarSecretLink @secret={{@model.id}} @mode="credentials" data-test-backend-credentials="iam">
          Generate credentials
        </ToolbarSecretLink>
      {{/if}}
      {{#if @model.canEdit}}
        <ToolbarSecretLink @secret={{@model.id}} @mode="edit" @replace={{true}}>
          Edit role
        </ToolbarSecretLink>
      {{/if}}
    </ToolbarActions>
  </Toolbar>
{{/if}}

{{#if (eq @mode "show")}}
  <div class="box is-fullwidth is-sideless is-paddingless is-marginless">
    {{#if (gt @model.credentialTypes.length 1)}}
      <Hds::Alert @type="inline" @color="warning" class="has-bottom-margin-s" as |A|>
        <A.Title>Warning</A.Title>
        <A.Description>
          This role has more than one
          <code>credential_type</code>, currently:
          {{join ", " @model.credentialTypes}}. When you next edit this role, you will have to choose a single credential
          type.
        </A.Description>
      </Hds::Alert>
    {{/if}}
    {{#each @model.fields as |attr|}}
      {{#if (eq attr.name "policyDocument")}}
        <InfoTableRow
          @label={{capitalize (or attr.options.label (humanize (dasherize attr.name)))}}
          @value={{@model.policyDocument}}
        >
          <pre><code class="is-paddingless">{{stringify (jsonify @model.policyDocument)}}</code></pre>
        </InfoTableRow>
      {{else}}
        <InfoTableRow
          @label={{capitalize (or attr.options.label (humanize (dasherize attr.name)))}}
          @value={{get @model attr.name}}
        />
      {{/if}}
    {{/each}}
  </div>
{{else}}
  <form {{on "submit" this.createOrUpdate}}>
    <div class="box is-sideless is-fullwidth is-marginless">
      <NamespaceReminder @mode={{@mode}} @noun="AWS role" />
      <MessageError @errorMessage={{this.errorMessage}} />
      {{#if (gt @model.credentialTypes.length 1)}}
        <Hds::Alert @type="inline" @color="warning" class="has-bottom-margin-s" as |A|>
          <A.Title>Warning</A.Title>
          <A.Description>
            This role has more than one
            <code>credential_type</code>, currently:
            {{join ", " @model.credentialTypes}}. Multiple credential types is deprecated and you must choose one in order to
            save this role.
          </A.Description>
        </Hds::Alert>
      {{/if}}
      {{#each (if (eq @mode "edit") (drop 1 (or @model.fields (array))) @model.fields) as |attr|}}
        <FormField data-test-field={{true}} @attr={{attr}} @model={{@model}} />
      {{/each}}
    </div>
    <div class="field is-grouped-split box is-fullwidth is-bottomless">
      <Hds::ButtonSet>
        <Hds::Button @text={{if (eq @mode "create") "Create role" "Save"}} type="submit" data-test-save />
        {{#if (eq @mode "create")}}
          <Hds::Button
            @text="Cancel"
            @color="secondary"
            @route="vault.cluster.secrets.backend.list-root"
            @model={{@model.backend}}
          />
        {{else}}
          <Hds::Button
            @text="Cancel"
            @color="secondary"
            @route="vault.cluster.secrets.backend.show"
            @models={{array @model.backend @model.id}}
          />
        {{/if}}
      </Hds::ButtonSet>
      {{#if this.invalidFormAlert}}
        <AlertInline
          data-test-invalid-form-alert
          class="has-top-padding-s"
          @type="danger"
          @message={{this.invalidFormAlert}}
        />
      {{/if}}
    </div>
  </form>
{{/if}}