<KvPageHeader @breadcrumbs={{@breadcrumbs}} @model={{@model}} @isEngineView={{true}} @pageTitle={{@model.backend}}>
  <:tabLinks>
    <LinkTo @route={{@routeName}} data-test-secrets-tab={{@routeName}}>Secrets</LinkTo>
    <LinkTo @route="configuration" data-test-secrets-tab="Configuration">Configuration</LinkTo>
  </:tabLinks>

  <:toolbarFilters>
    <div class="navigate-filter">
      <div class="field" data-test-nav-input>
        <p class="control has-icons-left">
          {{! template-lint-disable no-down-event-binding }}
          <Input
            id="secret-filter"
            class="filter input"
            placeholder="Filter secrets"
            @value={{@model.filterValue}}
            @type="text"
            data-test-component="navigate-input"
            {{on "input" this.handleInput}}
            {{on "keydown" this.handleKeyDown}}
            {{on "focus" this.setFilterIsFocused}}
            {{did-insert this.focusInput}}
            autocomplete="off"
          />
          <Icon @name="search" class="search-icon has-text-grey-light" />
        </p>
      </div>
    </div>
    {{#if this.filterIsFocused}}
      {{#if this.filterMatchesASecretPath}}
        <p class="help has-text-grey is-size-8 has-left-padding-xs">
          <kbd>ENTER</kbd>
          to go to see details.
        </p>
      {{else}}
        <p class="help has-text-grey is-size-8 has-left-padding-xs">
          <kbd>TAB</kbd>
          to autocomplete.
        </p>
      {{/if}}
    {{/if}}
  </:toolbarFilters>

  <:toolbarActions>
    {{! TODO this create link route needs to handle creating from a directory e.g. beep/boop/  "initialKey"}}
    <ToolbarLink @route="create" @type="add">Create secret</ToolbarLink>
  </:toolbarActions>
</KvPageHeader>
{{! TODO add permissions on the menu items }}
{{#if @model.secrets}}
  {{#each @model.secrets as |secret|}}
    <LinkedBlock
      class="list-item-row"
      @params={{array (if secret.pathIsDirectory "list-directory" "secret.details") secret.fullSecretPath}}
      @linkPrefix={{this.mountPoint}}
    >
      <div class="level is-mobile">
        <div class="level-left">
          <div>
            <Icon @name="user" class="has-text-grey-light" />
            <span class="has-text-weight-semibold is-underline">
              {{secret.path}}
            </span>
          </div>
        </div>
        <div class="level-right is-flex is-paddingless is-marginless">
          <div class="level-item">
            <PopupMenu>
              <nav class="menu">
                <ul class="menu-list">
                  {{#if secret.pathIsDirectory}}
                    <li>
                      <LinkTo @route="list-directory" @model={{secret.fullSecretPath}}>
                        Content
                      </LinkTo>
                    </li>
                  {{else}}
                    {{#if (or secret.canReadData secret.canReadMetadata)}}
                      <li>
                        <LinkTo @route="secret.details" @model={{secret.fullSecretPath}}>
                          Details
                        </LinkTo>
                      </li>
                    {{/if}}
                    {{#if secret.canReadMetadata}}
                      <li>
                        <LinkTo @route="secret.metadata.versions" @model={{secret.fullSecretPath}}>
                          View version history
                        </LinkTo>
                      </li>
                    {{/if}}
                    {{#if secret.canEditData}}
                      <li>
                        <LinkTo @route="secret.edit" @model={{secret.fullSecretPath}}>
                          Create new version
                        </LinkTo>
                      </li>
                    {{/if}}
                    {{#if secret.canDeleteMetadata}}
                      <li>
                        <ConfirmAction
                          @buttonClasses="link is-destroy"
                          @onConfirmAction={{fn this.onDelete secret}}
                          @confirmMessage={{"This will permanently delete this secret and all its versions."}}
                          @cancelButtonText="Cancel"
                          data-test-secret-delete="true"
                        >
                          Permanently delete
                        </ConfirmAction>
                      </li>
                    {{/if}}
                  {{/if}}
                </ul>
              </nav>
            </PopupMenu>
          </div>
        </div>
      </div>
    </LinkedBlock>
  {{/each}}
{{else}}
  {{#if @model.filterValue}}
    <EmptyState @title="There are no secrets matching &quot;{{@model.filterValue}}&quot;. Presse enter to add one." />
  {{else}}
    <EmptyState
      data-test-secret-list-empty-state
      @title="No secrets yet"
      @message="When created, secrets will be listed here. Create a secret to get started."
    >
      <LinkTo class="has-top-margin-xs" @route="create">
        Create secret
      </LinkTo>
    </EmptyState>
  {{/if}}
{{/if}}