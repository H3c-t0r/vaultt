---
layout: docs
page_title: Vault Proxy Static Secret Caching
description: |-
  Vault Proxy's static secret caching functionality allows you to cache KVv1 and KVv2 secrets for calling clients.
  The secrets will be automatically updated by Proxy, minimizing requests made to Vault, and offering resiliency.
---

# Vault Proxy static secret caching

Use static secret caching with Vault Proxy to cache KVv1 and KVv2 secrets to
minimize requests made to Vault and provide resilient connections for clients.

## Required permissions

Vault Proxy uses Vault events and auto-auth to monitor secret status and make
appropriate cache updates.
1. Enable [auto-auth](/vault/docs/agent-and-proxy/autoauth).
1. Create an auto-auth token with permission to subscribe to KV event updates
with the [Vault event system](/vault/docs/concepts/events). For example, to
create a policy that grants access to static secret (KVv1 and KVv2) events:
 ```hcl
 path "sys/events/subscribe/kv*" {
   capabilities = ["read"]
 }
   ```

Subscribing to KV events means that Proxy receives updates as soon as a secret
changes, which reduces staleness in the cache. Vault Proxy only checks for a
secret update if an event notification indicates that the related secret was
updated.

Additionally, tokens accessing static secrets in the cache will need the ability to access [`sys/capabilies-self`](/vault/api-docs/system/capabilities-self)
with the `update` capability. This capability allows a client to know what capabilities have on a current path, and allows
a token to find out capabilities on multiple paths with a single request, instead of requiring the token to reach out to
each explicitly and see if it gets a `403` response. This is used to efficiently maintain up-to-date access management
on the cache. If a token has its access to a KV secret revoked, this will allow Proxy to know, so that it can prevent
that token from accessing the cached secret.

This permission is provided in the [`default` policy attached by default to all Vault tokens](/vault/docs/concepts/policies#default-policy),
and, unless this has been modified, will be attached by default to all tokens. For completeness, or in case you wish to
apply this permission in a way other than via the `default` policy, the policy snippet required for this functionality
is as follows:

   ```hcl
    path "sys/capabilities-self" {
        capabilities = ["update"]
    }
   ```

The period at which capabilities for each token using Proxy will be checked is configured with the `static_secret_token_capability_refresh_interval`
configuration, described below. The default is to check per token every five minutes. For a setup where the `api_proxy`
has been configured with `use_auto_auth_token` as `true` or `force`, and all requests going through Proxy will be
using this sole token, this will be a single request to Vault per this interval, no matter how many secrets are
being cached.

## Functionality

When enabled, Vault Proxy will cache `GET`s to KVv1 and KVv2 endpoints. When a `GET` is made to a KV secret,
we will cache the response in Proxy's cache. Once the response is cached, subsequent `GET`s to this secret will
be served from the cache instead of being forwarded to Vault, as long as this client has access to this secret
in Vault.

If a token requests a KV secret, we store in the cache that this token has the capability to access a secret.
Therefore, subsequent requests by the same token will be able to access this secret from the cache. For a second
token to access the same secret, it must first complete a successful `GET` to the secret before its permission
to access the secret is cached, and its subsequent requests can be served from the cache instead of Vault itself.

Vault Proxy uses the [event system](/vault/docs/concepts/events) to keep the cache up to date. It will
pay attention to events that indicate both that the secret is one we have in our cache, and also that
the secret has been modified (e.g. changed, deleted). Upon receiving such an event, it will update or
evict the cache entry as appropriate.

Vault Proxy will also intermittently check the permissions of tokens that can access cache entries. This interval
defaults to once every five minutes, but is configurable by the `static_secret_token_capability_refresh_interval` configuration.
Every interval, Proxy will perform a call to [`sys/capabilies-self`](/vault/api-docs/system/capabilities-self) on
each token's behalf to validate that it still has previously-demonstrated capabilities to read secrets from the cache.
If there is a difference, and a permission (or the token itself) has been revoked, then the cache will be updated,
and it will no longer be to able access those paths from the cache. Note that the `static_secret_token_capability_refresh_interval`
configuration can be seen as the maximum period after which permission to read a KV secret can be revoked that a
token will retain access.

As with other requests to Proxy when the cache is enabled, Proxy will return `HIT` or `MISS` in the `X-Cache`
response header for requests, to tell the client if it has been served from the cache. The `Age` header
will be added if it is a cache hit, to inform the client how long it has been in seconds since an update
to the secret. Note that a long age doesn't necessarily mean that the cache is stale, and could just mean
that it hasn't been updated in a while.

## Configuration

The top level `cache` block has the following configuration entries relating to static secret caching:

- `cache_static_secrets` `(bool: false)` - If set to true, this will enable caching of static secrets,
and therefore the ability for Proxy to serve KV secrets directly from the cache to clients that have
the permission to access them. This requires `auto_auth` to be configured elsewhere in Vault Proxy to
be set to `true`.

- `static_secret_token_capability_refresh_interval` `(duration: "5m", optional)` - The interval between Proxy
checking the permissions of tokens that have been used to access static secrets, to ensure that
the capability to read these secrets remains. This is managed by Proxy by performing a request to
[`sys/capabilies-self`](/vault/api-docs/system/capabilities-self) with the known tokens, and revoking
access to the cached secret for any secrets where access has been removed.
This duration can be seen as the maximum period after which permission to read a KV secret
can be revoked that a token will retain access. This configuration does nothing unless `cache_static_secrets` is
set to true.
Uses [duration format strings](/vault/docs/concepts/duration-format).

### Example configuration

Here is an example of a Vault Proxy configured with a `listener`, forced usage of the auto-auth token through the API proxy,
`auto-auth` configuration for `approle`, and `cache_static_secrets` configured, by setting it to true.

```hcl
# Other Vault Proxy configuration blocks
# ...

cache {
  cache_static_secrets = true
  static_secret_token_capability_refresh_interval = "1m"
}

api_proxy {
  use_auto_auth_token = "force"
}

listener "tcp" {
    address = "127.0.0.1:8100"
    tls_disable = true
}

auto_auth {
  method {
    type = "approle"
    config = {
      role_id_file_path = "roleid"
      secret_id_file_path = "secretid"
      remove_secret_id_file_after_reading = false
    }
  }
```
[event-system]: /vault/docs/concepts/events
