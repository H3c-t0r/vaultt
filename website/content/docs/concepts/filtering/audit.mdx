---
layout: docs
page_title: Filter syntax for audit results
description: >-
  Learn about the behavior and syntax for filtering audit data.
---

# Filter syntax for audit results

As of Vault 1.16.0, you can enable audit devices with a `filter` option to limit
the audit entries written to a particular audit log and fine-tune your auditing
process. 

<Warning title="Proceed with caution">

  Filtering audit logs is an advanced feature. Exclusively enabling filtered
  devices without configuring an audit fallback may lead to gaps in your audit
  logs.
  
  **Always** test your audit configuration in a non-production environment
  before deploying filters to production. And make sure to read the
  [Vault security model](/vault/docs/internals/security) and
  [filtering overview](/vault/docs/concepts/filtering) to familiarize yourself
  with Vault auditing and filtering basics before enabling filtered audit 
  devices.

</Warning>

Once you enable an audit device with a filter, every audit entry Vault sends to
that audit device is compared to the predicate expression in the filter. Only
audit entries that match the filter are written to the audit log for the device.

When you enable filtered audit devices, the behavior of any existing audit
device and the behavior of new audit devices that **do not** use filters remain
unchanged. 

## Fallback auditing devices

Filtering adds flexibility to your auditing workflows, but filtering also adds
complexity that can lead to entries missing from your logs by mistake. For
example, writing audit entries to one device for `(N < 10)` and another device
for `(N > 10)`would exclude audit entires where `(N == 10)`, which may not be
the intended behavior.

The fallback audit device saves all audit entires that would otherwise get
filtered out and dropped from the audit record. Enabling an audit device with
the `fallback` parameter ensures that Vault continues to adhere to the default
[security model](/vault/docs/internals/security) which mandates that all
requests and responses must be successfully logged before clients receive secret
material.

<Warning title="Use a fallback to avoid missing audit entries">

  For Vault installations that use filtered audit devices **exclusively**,
  configuring a fallback audit device is the only way to guarantee a comparable
  security standard as Vault installations that only use standard, non-filtered
  audit devices.

</Warning>

### Fallback telemetry metrics

When the fallback device successfully writes an audit entry to the audit log,
Vault emits a
[fallback 'success' metric](/vault/docs/internals/telemetry/metrics/audit#vault-audit-fallback-success).

If you enable filtering **without** a fallback device, Vault emits a
[fallback 'miss' metric](/vault/docs/internals/telemetry/metrics/audit#vault-audit-fallback-miss)
metric anytime an audit entry would have been written to the fallback so you can
track how many auditable events you have lost.

## Audit device limitations

1. You cannot add filtering to an existing audit device.
1. You can configure filtering when enabling one of the following supported audit device types:
    - [file](/vault/docs/audit/file)
    - [socket](/vault/docs/audit/socket)
    - [syslog](/vault/docs/audit/syslog)
1. You can only designate one auditing fallback device.

## Filtering and test messages

By default, Vault sends a test message to the audit device when you enable it.
Depending on how you configure your filters, the default test message may fail
the predicate expression and not write to the new device.

You can determine whether the test message should appear in the sink for the 
newly enabled audit device based on the following property
table, which are common to all default test messages.

Property      | Value
------------- | ----------------
`mount_point` | empty
`mount_type`  | empty
`namespace`   | empty
`operation`   | `update`
`path`        | `sys/audit/test`

## `filter` properties for audit devices

Filters can only reference the following properties of an audit entry:

Property      | Example                             | Description
------------- | ----------------------------------- | --------------------------
`mount_point` | `mount_point == auth/oidc`          | Log all entries for the `auth/oidc` mount point
`mount_type`  | `mount_type == kv`                  | Log all entries from `kv` plugins
`namespace`   | `namespace != \"\"`                 | Log all entries **not** in the root namespace
`operation`   | `operation == read`                 | Log all read operations
`path`        | `path == auth/approle/login`        | Log all activity against the AppRole login path

## A practical example

Assume you already have an audit file called `vault-audit.log` but you want to
filter your audit entries and save all the key/value ('kv ) plugin events to a
specific audit log file called `kv-audit.log`.

To filter the events:

1. Enable a `file` audit device with a `mount_type` filter:
  ```shell-session
  vault audit enable                \
    -path kv-only                   \
    file                            \
    file_path=/logs/kv-audit.log    \
    filter="mount_type == kv"
  ```
1. Enable a fallback device:
  ```shell-session
  vault audit enable                \
    fallback=true                   \
    -path=my-fallback               \
    -description="fallback device"  \
    file file_path=/tmp/kv-audit.fallback.log 
  ```
1. Confirm the audit devices are enabled:
  ```shell-session
    vault audit list --detailed
  ```
1. Enable a new `kv` secrets engine called `my-kv`:
  ```shell-session
    vault secrets enable -path my-kv kv-v2
  ```
1. Write secret data to the `kv` engine:
  ```shell-session
    vault kv put my-kv my_secret=always_angry
  ```

The `/var/kv-audit.log` now includes two entries: one for the command that
enabled `my-kv` and one for the command that wrote a secret to `my-kv`. Entries
for the other commands are captured by the fallback device. And the original
audit file, `vault-audit.log` continues to capture all audit events.
