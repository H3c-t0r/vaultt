---
layout: docs
page_title: Best practices for CI/CD pipelines
description: |-
  Identity recommendations for CI/CD pipelines
---

# Best practices for CI/CD pipelines

## Problem description

Orchestrators (Nomad, Terraform, Ansible, etc.) and continuous
integration/continuous delivery (CI/CD) tools (Jenkins, Bamboo, Azure Devops,
GitLab, GitHub Ops, etc.) authenticate to, and request secrets from, Vault
during deployment.

Typical CI/CD workflows can include multiple pipelines each with multiple
deployment targets (e.g., application, service, infrastructure element).

Assume you have a CI/CD workflow that includes two pipelines:

1. Pipeline<sub>1</sub> has two deploy targets: a cloud application and an
   API service.
1. Pipeline<sub>2</sub> has three deploy targets: AWS configuration, PyPi
   publication, and Maven publication.

How would you organize and coordinate the relevant secrets? 

## Option 1: Use a unique identity for each pipeline and deployed target

Every CI/CD pipeline has a unique identity (e.g. app role, token with an entity
alias). When a pipeline runs, it authenticates to Vault **once** and gives
each deployed component a unique identity.

Any component that needs access to secrets can use its provided identity during
bootstrap to authenticate to Vault and retrieve the relevant information.

From a Vault client perspective you have:

- a client for the Master CI/CD identity
- a client for each pipeline
- a client for each app or service deployed by the workflow.

## Option 2: Use a unique identity for each pipeline

Every CI/CD pipeline has a unique identity (e.g. app role, token with an entity
alias). The pipeline authenticates to Vault **once** and retrieves all the
relevant secrets.

Any component that needs access to secrets will have the relevant information
immediately. 

From a Vault client perspective option 2 means you have:

- a client for the Master CI/CD identity
- a client for each pipeline

## Option 3: Use a central CI/CD identity

The overall CI/CD orchestrator has central identity (e.g. app role, token with
an entity alias). The orchestrator starts by authenticating to Vault and
provides each pipeline with any secrets the pipeline needs in addition to any
secrets needed by the components that pipeline deploys.

From a Vault client perspective option 3 means you have a single client for the
Master CI/CD identity.

## Recommendation

In general, there should be little or no gap between the distribution of a
secret and when it is accessed.

From a threat model and security assessment perspective, **option 1** is the
most secure approach because it uses the
[principle of least privilege](/vault/tutorials/recommended-patterns/pattern-centralized-secrets#the-principle-of-least-privilege-polp).

With option 1, the pipeline does not have access to any additional secrets.
Instead, each application, service, or infrastructure element fetches its own
secrets during bootstrapping. As a result, if you find a security threat or have
to revoke access for some reason, the only entity affected is the specific entity
for which you revoked access. The rest of your workflow can (potentially)
continue unaffected.

Options 2 and 3 both pose risks if a malicious actor gains access to your
pipelines or CI/CD workflow. In the case of option 2 and 3, the malicious
actor immediately gains access to either some, or all, of the secrets used by
your applications and services.

Revoking access is also harder with options 2 and 3. Revoking access with
option 2 means that the entire pipeline loses access, and revoking access with
option 3 means that the entire workflow goes down.

## Try it out!
 
[Onboarding Applications to Vault Using Terraform: A Practical Guide](https://www.hashicorp.com/blog/onboarding-applications-to-vault-using-terraform-a-practical-guide)
provides a detailed example of an automated HashiCorp Vault onboarding
system with Terraform that uses secure identity assignment, naming standards,
ACL policy templates, namespaces, pre-created application entities, and
workflows driven by VCS and CI/CD.
