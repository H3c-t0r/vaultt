
### External plugin variables take precedence over system variables ((#external-plugin-variables))

#### Affected versions

- 1.16.0+

#### Behavior change

Vault gives precedence to plugin environment variables over system environment variables when loading
external plugins. The behavior for builtin plugins and plugins that do not specify
additional environment variables is unaffected.

For example, if you register an external plugin with `SOURCE=child` in the
[env](/vault/api-docs/system/plugins-catalog#env) parameter but the main Vault
process already has `SOURCE=parent` defined, the plugin process starts
with `SOURCE=child`.

Vault enumerates all plugins in the catalog and notes potential conflicts during
the unseal process. Vault prints warnings for the plugins with conflicting
environment variables or logs an informational entry when there are no conflicts.

Refer to the [plugin management](/vault/docs/plugins/plugin-management) page for
more details on plugin environment variables.

<Highlight title="Avoid conflicts with containerized plugins">

  Containerized plugins do not inherit system-defined environment variables.
  As a result, containerized
  plugins cannot have conflicts with Vault environment variables.

</Highlight>

#### Workaround

To opt out of the precedence change, set the
`VAULT_PLUGIN_USE_LEGACY_ENV_LAYERING` environment variable to `true` for the
main Vault process:

```shell-session
$ export VAULT_PLUGIN_USE_LEGACY_ENV_LAYERING=true
```

Setting `VAULT_PLUGIN_USE_LEGACY_ENV_LAYERING` to `true` tells Vault to
prioritize environment variables from the Vault server environment whenever the
system detects a variable conflict.

For example, if you set `VAULT_PLUGIN_USE_LEGACY_ENV_LAYERING` to `true` and
register an external plugin with `SOURCE=child` but the main Vault process
already has `SOURCE=parent` defined, the plugin process starts with
`SOURCE=parent`.